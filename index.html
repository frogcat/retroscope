<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Retroscope</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
  <script src="https://frogcat.github.io/leaflet-tilelayer-mask/leaflet-tilelayer-mask.js"></script>
  <script>
    var config = {
      gsi: {
        urlTemplate: "https://cyberjapandata.gsi.go.jp/xyz/{$1}/{z}/{x}/{y}.{$2}",
        options: {
          attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        }
      },
      mw: {
        urlTemplate: "http://mapwarper.net/maps/tile/{$1}/{z}/{x}/{y}.png",
        options: {
          attribution: "<a href='http://mapwarper.net/maps/{$1}'>Map Warper</a>"
        }
      },
      nypl: {
        urlTemplate: "http://maps.nypl.org/warper/maps/tile/{$1}/{z}/{x}/{y}.png",
        options: {
          attribution: "<a href='http://maps.nypl.org/warper/maps/{$1}'>NYPL Map Warper</a>"
        }
      },
      osm: {
        urlTemplate: "http://{s}.tile.osm.org/{z}/{x}/{y}.png",
        options: {
          attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors"
        }
      },
      habs: {
        urlTemplate: "http://www.finds.jp/ws/tmc/1.0.0/Kanto_Rapid-900913-L/{z}/{x}/{y}.png",
        options: {
          attribution: "<a href='http://habs.dc.affrc.go.jp/'>歴史的農業環境閲覧システム(NIAES)</a>",
          minZoom: 1,
          maxNativeZoom: 17
        }
      },
      nls: {
        urlTemplate: "http://nls-0.tileserver.com/nls/{z}/{x}/{y}.jpg",
        options: {
          attribution: "Historical maps from 1919-47  <a href='http://geo.nls.uk/maps/api/'>NLS Maps API</a>",
          minZoom: 1,
          maxNativeZoom: 17
        }
      },
      kjm: {
        urlTemplate: "https://sv53.wadax.ne.jp/~ktgis-net/kjmapw/kjtilemap/{$1}/{$2}/{z}/{x}/{y}.png",
        options: {
          attribution: "<a href='http://ktgis.net/kjmapw/'>今昔マップ on the web</a>",
          tms: true
        }
      },
      hinata: {
        urlTemplate: "https://mtile.pref.miyazaki.lg.jp/tile/{$1}/{$2}/{z}/{x}/{y}.png",
        options: {
          attribution: "<a href='https://hgis.pref.miyazaki.lg.jp/hinata/'>ひなたGIS</a>",
          tms: true
        }
      }
    };

    function getInstance(a) {
      var tokens = a.split("/");
      var dig = function(src) {
        switch (typeof src) {
          case "object":
            var dst = {};
            for (var key in src) dst[key] = dig(src[key]);
            return dst;
          case "string":
            var a = "" + src;
            tokens.forEach(function(b, i) {
              a = a.replace("{$" + i + "}", b);
            });
            return a;
          default:
            return src;
        }
      };
      return dig(config[tokens[0]]);
    }

    window.addEventListener("load", function() {
      if (location.search.match(/^\?(.+)&(.+)$/)) {
        var bg = RegExp.$1;
        var fg = RegExp.$2;
        var layers = [bg, fg].map(function(a, i) {
          var o = getInstance(a);
          if (o && i === 0) return L.tileLayer(o.urlTemplate, o.options);
          if (o && i === 1) return L.tileLayer.mask(o.urlTemplate, o.options);
          return null;
        });
        if (layers[0] && layers[1]) {
          var map = L.map("map", L.extend({
            zoom: 15,
            center: [35.6707, 139.7852]
          }, L.Hash.parseHash(location.hash)));

          var basemaps = {};
          basemaps[bg] = layers[0].addTo(map);
          if (!basemaps.osm) basemaps.osm = L.tileLayer(config.osm.urlTemplate, config.osm.options);
          layers[1].addTo(map);
          L.control.layers(basemaps).addTo(map);
          map.zoomControl.setPosition("bottomright");
          map.attributionControl.addAttribution("<a href='https://github.com/frogcat/retroscope'>fork me on GitHub</a>");
          L.hash(map);
          map.on("mousemove", function(event) {
            layers[1].setCenter(event.containerPoint);
          });
          return;
        }
      }


      document.body.innerHTML = "<div style='margin:20px;'><h1>Retroscope</h1><h2>examples</h2><ul id='list'></ul></div>";

      [{
        href: "?gsi/ort/jpg&habs#15/35.6707/139.7852",
        text: "迅速測図 on 地理院地図(オルソ)"
      }, {
        href: "?osm&gsi/ort/jpg#15/35.6707/139.7852",
        text: "地理院地図(オルソ) on OpenStreetMap"
      }, {
        href: "?mw/20822&osm#11/35.3275/139.8542",
        text: "osm on mapwarper"
      }, {
        href: "?mw/20822&gsi/pale/png#12/35.0660/140.0735",
        text: "地理院地図(淡色地図) on mapwarper"
      }, {
        href: "?gsi/ort_riku10/png&gsi/ort_USA10/png#16/35.6701/139.6974",
        text: "戦前と戦後の代々木公園周辺"
      }].forEach(function(v) {
        var li = document.createElement("li");
        var a = document.createElement("a");
        a.setAttribute("href", v.href);
        a.appendChild(document.createTextNode(v.text));
        li.appendChild(a);
        document.getElementById("list").appendChild(li);
      });

    });
  </script>
</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
</body>

</html>
